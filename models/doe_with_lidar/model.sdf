<?xml version='1.0'?>
<sdf version="1.9">

  <model name="doe_with_lidar">
    <include merge="true">
      <uri>model://iris_with_standoffs</uri>
    </include>

    <plugin filename="gz-sim-joint-state-publisher-system"
      name="gz::sim::systems::JointStatePublisher">
    </plugin>

    <plugin
      filename="gz-sim-odometry-publisher-system"
      name="gz::sim::systems::OdometryPublisher">
      <odom_frame>odom</odom_frame>
      <robot_base_frame>base_link</robot_base_frame>
      <dimensions>3</dimensions>
    </plugin>

    <plugin filename="gz-sim-lift-drag-system"
        name="gz::sim::systems::LiftDrag">
      <a0>0.3</a0>
      <alpha_stall>1.4</alpha_stall>
      <cla>4.2500</cla>
      <cda>0.10</cda>
      <cma>0.0</cma>
      <cla_stall>-0.025</cla_stall>
      <cda_stall>0.0</cda_stall>
      <cma_stall>0.0</cma_stall>
      <area>0.002</area>
      <air_density>1.2041</air_density>
      <cp>0.084 0 0</cp>
      <forward>0 1 0</forward>
      <upward>0 0 1</upward>
      <link_name>rotor_0</link_name>
    </plugin>
    <plugin filename="gz-sim-lift-drag-system"
        name="gz::sim::systems::LiftDrag">
      <a0>0.3</a0>
      <alpha_stall>1.4</alpha_stall>
      <cla>4.2500</cla>
      <cda>0.10</cda>
      <cma>0.0</cma>
      <cla_stall>-0.025</cla_stall>
      <cda_stall>0.0</cda_stall>
      <cma_stall>0.0</cma_stall>
      <area>0.002</area>
      <air_density>1.2041</air_density>
      <cp>-0.084 0 0</cp>
      <forward>0 -1 0</forward>
      <upward>0 0 1</upward>
      <link_name>rotor_0</link_name>
    </plugin>

    <plugin filename="gz-sim-lift-drag-system"
        name="gz::sim::systems::LiftDrag">
      <a0>0.3</a0>
      <alpha_stall>1.4</alpha_stall>
      <cla>4.2500</cla>
      <cda>0.10</cda>
      <cma>0.0</cma>
      <cla_stall>-0.025</cla_stall>
      <cda_stall>0.0</cda_stall>
      <cma_stall>0.0</cma_stall>
      <area>0.002</area>
      <air_density>1.2041</air_density>
      <cp>0.084 0 0</cp>
      <forward>0 1 0</forward>
      <upward>0 0 1</upward>
      <link_name>rotor_1</link_name>
    </plugin>
    <plugin filename="gz-sim-lift-drag-system"
        name="gz::sim::systems::LiftDrag">
      <a0>0.3</a0>
      <alpha_stall>1.4</alpha_stall>
      <cla>4.2500</cla>
      <cda>0.10</cda>
      <cma>0.0</cma>
      <cla_stall>-0.025</cla_stall>
      <cda_stall>0.0</cda_stall>
      <cma_stall>0.0</cma_stall>
      <area>0.002</area>
      <air_density>1.2041</air_density>
      <cp>-0.084 0 0</cp>
      <forward>0 -1 0</forward>
      <upward>0 0 1</upward>
      <link_name>rotor_1</link_name>
    </plugin>

    <plugin filename="gz-sim-lift-drag-system"
        name="gz::sim::systems::LiftDrag">
      <a0>0.3</a0>
      <alpha_stall>1.4</alpha_stall>
      <cla>4.2500</cla>
      <cda>0.10</cda>
      <cma>0.0</cma>
      <cla_stall>-0.025</cla_stall>
      <cda_stall>0.0</cda_stall>
      <cma_stall>0.0</cma_stall>
      <area>0.002</area>
      <air_density>1.2041</air_density>
      <cp>0.084 0 0</cp>
      <forward>0 -1 0</forward>
      <upward>0 0 1</upward>
      <link_name>rotor_2</link_name>
    </plugin>
    <plugin filename="gz-sim-lift-drag-system"
        name="gz::sim::systems::LiftDrag">
      <a0>0.3</a0>
      <alpha_stall>1.4</alpha_stall>
      <cla>4.2500</cla>
      <cda>0.10</cda>
      <cma>0.0</cma>
      <cla_stall>-0.025</cla_stall>
      <cda_stall>0.0</cda_stall>
      <cma_stall>0.0</cma_stall>
      <area>0.002</area>
      <air_density>1.2041</air_density>
      <cp>-0.084 0 0</cp>
      <forward>0 1 0</forward>
      <upward>0 0 1</upward>
      <link_name>rotor_2</link_name>
    </plugin>

    <plugin filename="gz-sim-lift-drag-system"
        name="gz::sim::systems::LiftDrag">
      <a0>0.3</a0>
      <alpha_stall>1.4</alpha_stall>
      <cla>4.2500</cla>
      <cda>0.10</cda>
      <cma>0.0</cma>
      <cla_stall>-0.025</cla_stall>
      <cda_stall>0.0</cda_stall>
      <cma_stall>0.0</cma_stall>
      <area>0.002</area>
      <air_density>1.2041</air_density>
      <cp>0.084 0 0</cp>
      <forward>0 -1 0</forward>
      <upward>0 0 1</upward>
      <link_name>rotor_3</link_name>
    </plugin>
    <plugin filename="gz-sim-lift-drag-system"
        name="gz::sim::systems::LiftDrag">
      <a0>0.3</a0>
      <alpha_stall>1.4</alpha_stall>
      <cla>4.2500</cla>
      <cda>0.10</cda>
      <cma>0.0</cma>
      <cla_stall>-0.025</cla_stall>
      <cda_stall>0.0</cda_stall>
      <cma_stall>0.0</cma_stall>
      <area>0.002</area>
      <air_density>1.2041</air_density>
      <cp>-0.084 0 0</cp>
      <forward>0 1 0</forward>
      <upward>0 0 1</upward>
      <link_name>rotor_3</link_name>
    </plugin>

    <plugin filename="gz-sim-apply-joint-force-system"
      name="gz::sim::systems::ApplyJointForce">
      <joint_name>rotor_0_joint</joint_name>
    </plugin>
    <plugin filename="gz-sim-apply-joint-force-system"
      name="gz::sim::systems::ApplyJointForce">
      <joint_name>rotor_1_joint</joint_name>
    </plugin>
    <plugin filename="gz-sim-apply-joint-force-system"
      name="gz::sim::systems::ApplyJointForce">
      <joint_name>rotor_2_joint</joint_name>
    </plugin>
    <plugin filename="gz-sim-apply-joint-force-system"
      name="gz::sim::systems::ApplyJointForce">
      <joint_name>rotor_3_joint</joint_name>
    </plugin>

    <!-- <plugin filename="gz-sim-linearbatteryplugin-system"
      name="gz::sim::systems::LinearBatteryPlugin">
      <battery_name>lipo_3500mAh</battery_name>
      <fix_issue_225>true</fix_issue_225>
      <open_circuit_voltage_constant_coef>12.6</open_circuit_voltage_constant_coef>
      <open_circuit_voltage_linear_coef>-2.7</open_circuit_voltage_linear_coef>
      <capacity>3.5</capacity>
      <voltage>12.6</voltage>
      <initial_charge>3.5</initial_charge>
      <power_load>200.0</power_load>
      <start_draining>false</start_draining>
    </plugin> -->

    <plugin name="ArduPilotPlugin"
      filename="ArduPilotPlugin">
      <fdm_addr>127.0.0.1</fdm_addr>
      <fdm_port_in>9002</fdm_port_in>
      <connectionTimeoutMaxCount>5</connectionTimeoutMaxCount>
      <lock_step>1</lock_step>
      <modelXYZToAirplaneXForwardZDown degrees="true">0 0 0 180 0 0</modelXYZToAirplaneXForwardZDown>
      <gazeboXYZToNED degrees="true">0 0 0 180 0 90</gazeboXYZToNED>

      <!-- Sensors -->
      <imuName>imu_link::imu_sensor</imuName>

      <!-- Control channels -->
      <!--
          incoming control command [0, 1]
          so offset it by 0 to get [0, 1]
          and divide max target by 1.
          offset = 0
          multiplier = 838 max rpm / 1 = 838
        -->
      <control channel="0">
        <jointName>rotor_0_joint</jointName>
        <useForce>1</useForce>
        <multiplier>838</multiplier>
        <offset>0</offset>
        <servo_min>1100</servo_min>
        <servo_max>1900</servo_max>
        <type>VELOCITY</type>
        <p_gain>0.20</p_gain>
        <i_gain>0</i_gain>
        <d_gain>0</d_gain>
        <i_max>0</i_max>
        <i_min>0</i_min>
        <cmd_max>2.5</cmd_max>
        <cmd_min>-2.5</cmd_min>
        <controlVelocitySlowdownSim>1</controlVelocitySlowdownSim>
      </control>

      <control channel="1">
        <jointName>rotor_1_joint</jointName>
        <useForce>1</useForce>
        <multiplier>838</multiplier>
        <offset>0</offset>
        <servo_min>1100</servo_min>
        <servo_max>1900</servo_max>
        <type>VELOCITY</type>
        <p_gain>0.20</p_gain>
        <i_gain>0</i_gain>
        <d_gain>0</d_gain>
        <i_max>0</i_max>
        <i_min>0</i_min>
        <cmd_max>2.5</cmd_max>
        <cmd_min>-2.5</cmd_min>
        <controlVelocitySlowdownSim>1</controlVelocitySlowdownSim>
      </control>

      <control channel="2">
        <jointName>rotor_2_joint</jointName>
        <useForce>1</useForce>
        <multiplier>-838</multiplier>
        <offset>0</offset>
        <servo_min>1100</servo_min>
        <servo_max>1900</servo_max>
        <type>VELOCITY</type>
        <p_gain>0.20</p_gain>
        <i_gain>0</i_gain>
        <d_gain>0</d_gain>
        <i_max>0</i_max>
        <i_min>0</i_min>
        <cmd_max>2.5</cmd_max>
        <cmd_min>-2.5</cmd_min>
        <controlVelocitySlowdownSim>1</controlVelocitySlowdownSim>
      </control>

      <control channel="3">
        <jointName>rotor_3_joint</jointName>
        <useForce>1</useForce>
        <multiplier>-838</multiplier>
        <offset>0</offset>
        <servo_min>1100</servo_min>
        <servo_max>1900</servo_max>
        <type>VELOCITY</type>
        <p_gain>0.20</p_gain>
        <i_gain>0</i_gain>
        <d_gain>0</d_gain>
        <i_max>0</i_max>
        <i_min>0</i_min>
        <cmd_max>2.5</cmd_max>
        <cmd_min>-2.5</cmd_min>
        <controlVelocitySlowdownSim>1</controlVelocitySlowdownSim>
      </control>

    </plugin>


    <link name="base_scan">
      <pose>0 0 0.075077 0 0 0</pose>
      <inertial>
        <mass>0.1</mass>
        <inertia>
          <ixx>0.000166667</ixx>
          <iyy>0.000166667</iyy>
          <izz>0.000166667</izz>
        </inertia>
      </inertial>

      <collision name="collision">
        <geometry>
          <box>
            <size>0.05 0.05 0.05</size>
          </box>
        </geometry>
      </collision>

      <visual name="visual">
        <geometry>
          <box>
            <size>0.05 0.05 0.05</size>
          </box>
        </geometry>
      </visual>

      <sensor name='gpu_lidar' type='gpu_lidar'>
        <!-- <gz_frame_id>base_scan</gz_frame_id> -->
        <pose>0 0 0 0 0 0</pose>
        <topic>lidar</topic>
        <update_rate>5</update_rate>
        <lidar>
          <scan>
            <horizontal>
              <samples>256</samples>
              <resolution>1</resolution>
              <min_angle>-2.79253</min_angle>
              <max_angle>2.79253</max_angle>
            </horizontal>
            <vertical>
              <samples>1</samples>
              <resolution>1</resolution>
              <min_angle>0.0</min_angle>
              <max_angle>0.0</max_angle>
            </vertical>
          </scan>
          <range>
            <min>0.2</min>
            <max>50.0</max>
            <resolution>0.01</resolution>
          </range>
          <noise>
            <type>gaussian</type> <!-- Type of noise, e.g., gaussian -->
            <mean>0.0</mean> <!-- Mean of the noise distribution -->
            <stddev>0.02</stddev> <!-- Standard deviation of the noise -->
            </noise>
        </lidar>
        <visualize>true</visualize>
      </sensor>
    </link>

    <joint name="lidar_joint" type="revolute">
      <parent>base_link</parent>
      <child>base_scan</child>
      <axis>
        <xyz>0 0 1</xyz>
        <limit>
          <lower>0</lower>
          <upper>0</upper>
        </limit>
        <dynamics>
          <damping>1</damping>
        </dynamics>
      </axis>
    </joint>

    <!--floppy probe-->
    <link name="upper_arm">
        <pose relative_to="base_link">.2 0 0 0 0 0</pose>
        <inertial>
            <mass>0.001</mass>
            <inertia>
                <ixx>0.0001</ixx>
                <ixy>0</ixy>
                <ixz>0</ixz>
                <iyy>0.0001</iyy>
                <iyz>0</iyz>
                <izz>0.0001</izz>
            </inertia>
        </inertial>
        <visual name='visual'>
            <geometry>
                <box>
                    <size>0.2 0.025 0.05</size>
                </box>
            </geometry>
            <material>
                <ambient>0.0 1 0.0 1</ambient>
                <diffuse>0.0 1 0.0 1</diffuse>
                <specular>0.0 1 0.0 1</specular>
            </material>
        </visual>
    </link>
    <link name="forearm">
        <pose relative_to="upper_arm">0.2 0 0 0 0 0</pose>
        <inertial>
            <mass>0.001</mass>
            <inertia>
                <ixx>0.0001</ixx>
                <ixy>0</ixy>
                <ixz>0</ixz>
                <iyy>0.0001</iyy>
                <iyz>0</iyz>
                <izz>0.0001</izz>
            </inertia>
        </inertial>
        <visual name='visual'>
            <geometry>
                <box>
                    <size>0.2 0.025 0.05</size>
                </box>
            </geometry>
            <material>
                <ambient>0.0 1 0.0 1</ambient>
                <diffuse>0.0 1 0.0 1</diffuse>
                <specular>0.0 1 0.0 1</specular>
            </material>
        </visual>
    </link>
    <link name='probe'>
        <pose relative_to="forearm">0.1 0 0 0 0 0</pose> <!--angles are in radian-->
        <inertial>
            <mass>0.001</mass>
            <inertia>
                <ixx>0.0001</ixx>
                <ixy>0</ixy>
                <ixz>0</ixz>
                <iyy>0.0001</iyy>
                <iyz>0</iyz>
                <izz>0.0001</izz>
            </inertia>
        </inertial>
        <visual name='visual'>
            <geometry>
                <box>
                    <size>0.05 0.1 0.1</size>
                </box>
            </geometry>
            <material>
                <ambient>0.0 1 0.0 1</ambient>
                <diffuse>0.0 1 0.0 1</diffuse>
                <specular>0.0 1 0.0 1</specular>
            </material>
        </visual>
        <collision name='collision'>
            <geometry>
                <box>
                    <size>0.05 0.1 0.1</size>
                </box>
            </geometry>
            <surface>
                <friction>
                    <ode>
                        <mu>
                            50.0
                        </mu>
                        <mu2>
                            50.0
                        </mu2>
                    </ode>
                </friction>
                <contact>
                    <ode>
                    <max_vel>0</max_vel>
                    <min_depth>0.01</min_depth>
                    </ode>
                </contact>
                </surface>
        </collision>
        <sensor name='sensor_contact' type='contact'>
            <contact>
                <collision>collision</collision>
            </contact>
        </sensor>
    </link>
    <joint name='shoulder_joint' type='revolute'>
        <pose relative_to='upper_arm'>-.1 0 0 0 0 0</pose>
        <parent>base_link</parent>
        <child>upper_arm</child>
        <axis>
            <xyz expressed_in='__model__'>0 1 0</xyz>
            <limit>
                <lower>-1.79769e+308</lower>    <!--negative infinity-->
                <upper>1.79769e+308</upper>     <!--positive infinity-->
            </limit>
            <dynamics>
                <damping>10</damping>
                <spring_reference> .7 </spring_reference>
                <spring_stiffness> 400 </spring_stiffness>
            </dynamics>
        </axis>
    </joint>
    <joint name='elbow_joint' type='revolute'>
        <pose relative_to='forearm'>-.1 0 0 0 0 0</pose>
        <parent>upper_arm</parent>
        <child>forearm</child>
        <axis>
            <xyz expressed_in='__model__'>0 1 0</xyz>
            <limit>
                <lower>-1.79769e+308</lower>    <!--negative infinity-->
                <upper>1.79769e+308</upper>     <!--positive infinity-->
            </limit>
            <dynamics>
                <damping>10</damping>
                <spring_reference> -1.4 </spring_reference>
                <spring_stiffness> 400 </spring_stiffness>
            </dynamics>
        </axis>
    </joint>
    <joint name='wrist_joint' type='revolute'>
        <pose relative_to='probe'>-.025 0 0 0 0 0</pose>
        <parent>forearm</parent>
        <child>probe</child>
        <axis>
            <xyz expressed_in='__model__'>0 1 0</xyz>
            <limit>
                <lower>-1.79769e+308</lower>    <!--negative infinity-->
                <upper>1.79769e+308</upper>     <!--positive infinity-->
            </limit>
            <dynamics>
                <damping>10</damping>
                <spring_reference> .7 </spring_reference>
                <spring_stiffness> 400 </spring_stiffness>
            </dynamics>
        </axis>
    </joint>
    <plugin filename="SuctionPlugin"
            name="SuctionPlugin">
        <parent_link>probe</parent_link>
        <child_model>turbine</child_model>
        <child_link>base_link</child_link>
        <detach_topic>/detach</detach_topic>
        <attach_topic>/attach</attach_topic>
        <suction_force>100</suction_force>
    </plugin>

    <!-- floppy probe
    <link name='probe'>
        <pose relative_to="base_link">.4 0 0 0 0 0</pose> !angles are in radian
        <inertial>
            <mass>0.01</mass>
            <inertia>
                <ixx>0.01</ixx>
                <ixy>0</ixy>
                <ixz>0</ixz>
                <iyy>0.01</iyy>
                <iyz>0</iyz>
                <izz>0.01</izz>
            </inertia>
        </inertial>
        <visual name='visual'>
            <geometry>
                <box>
                    <size>0.5 0.05 0.1</size>
                </box>
            </geometry>
            <material>
                <ambient>0.0 1 0.0 1</ambient>
                <diffuse>0.0 1 0.0 1</diffuse>
                <specular>0.0 1 0.0 1</specular>
            </material>
        </visual>
        <collision name='collision'>
            <geometry>
                <box>
                    <size>0.5 0.05 0.1</size>
                </box>
            </geometry>
        </collision>
        <sensor name='sensor_contact' type='contact'>
            <contact>
                <collision>collision</collision>
            </contact>
        </sensor>
    </link>
    <plugin filename="SuctionPlugin"
            name="SuctionPlugin">
        <parent_link>probe</parent_link>
        <child_model>turbine</child_model>
        <child_link>base_link</child_link>
        <detach_topic>/detach</detach_topic>
        <attach_topic>/attach</attach_topic>
    </plugin>
    <joint name='probe_joint' type='revolute'>
        <pose relative_to='probe'>-.25 0 0 0 0 0</pose>
        <parent>base_link</parent>
        <child>probe</child>
        <axis>
            <xyz expressed_in='__model__'>0 1 0</xyz>
            <limit>
                <lower>-1.79769e+308</lower>    !negative infinity
                <upper>1.79769e+308</upper>     !positive infinity
            </limit>
            <dynamics>
                <damping>10</damping>
                <spring_reference> -.7 </spring_reference>
                <spring_stiffness> 100 </spring_stiffness>
            </dynamics>
        </axis>
    </joint> -->

  </model>

</sdf>
